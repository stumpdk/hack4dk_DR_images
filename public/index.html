<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <!-- Open Graph data -->
    <meta property="og:title" content="Opmærkning af DR's billeder" />
    <!--<meta property="og:url" content="http://www.bbhenriksen.dk/drsbilleder" />-->
    <meta property="og:image" content="http://www.bbhenriksen.dk/drsbilleder/frontimage.jpg" />
    <meta property="og:description" content="Klik her og hjælp med at få dem på nettet" />

    <title>Opmærkning af DR's billeder</title>
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>  
    <script src="js/jquery.taggd.js"></script>
    <script src="js/tagging.js"></script>
    <script src="js/typeahead.bundle.js"></script>
    <link rel="stylesheet" href="css/typeahead.css">  
    <link rel="stylesheet" href="css/normalize.css" />
    <link rel="stylesheet" href="css/taggd.css" />
	      
  <style>
    .img-full-width{
	    display: block;
	    width: 100%;
    }
    
    text-pad {
	    padding: 3px;
	}
	.btn-margin {
		margin-left:5px;
		margin-right:5px;
	}
	
	info {
		font-family: serif; 
		font-size: 0.8em; 
		position:absolute;
		top:4em;
		padding:10px;
	}	
	.login {
		position:relative;
		top:10px;
	    width: 100%;
	}
	#status {
		margin: 10px 10px 10px;
	}
	input.taggd-item-input {
		color:white;
	}
	.creative-commons-logo
	{
		float:right;
		max-width:200px;
		padding:5px;
	}
	.desc{
        /* background-color: #fff; */
   /* top: -22px;*/
    /* color: #fff; */
    /* left: 0; */
    opacity: 0.7;
    position: relative;
    /* width: 330px; */
}

.fix{
    width: 100%;
    padding: 0px;
}
#facebook-share-link{
	cursor: pointer;
    font-size: 0.9em;
}
.tt-menu {
  max-height: 150px;
  overflow-y: auto;

  /*width: 100%;*/
  width:226px;
  margin: 12px 0;
  padding: 8px 0;
  background-color: rgba(219, 50, 92, 0.75);
  border: 1px solid #ccc;
  border: 1px solid rgba(0, 0, 0, 0.2);
  -webkit-border-radius: 8px;
  -moz-border-radius: 8px;
  border-radius: 8px;
  -webkit-box-shadow: 0 5px 10px rgba(0,0,0,.2);
  -moz-box-shadow: 0 5px 10px rgba(0,0,0,.2);
  box-shadow: 0 5px 10px rgba(0,0,0,.2);
}
.tt-suggestion {
  padding: 3px 20px;
  /* font-size: 16px; */
  /* line-height: 24px; */
}
.tt-hint {
visibility:hidden;
}
.footer {
  position: absolute;
  bottom: 0;
  width: 100%;
  /* Set the fixed height of the footer here */
  height: 60px;
  /*background-color: #f5f5f5;*/
}
  </style>
	      
    </head>
    <body>
        <div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/da_DK/all.js#xfbml=1&version=v2.4&appId=976309079106997";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
	//FacebookModule();
</script>    	
    	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-69261113-1', 'auto');
  ga('send', 'pageview');

</script>
    	
    	<nav class="navbar navbar-default">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="./">Opmærkning af DR's billeder</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li><a href="search">Søg</a></li>
            <li><a href="latest">Seneste</a></li>
            <li><a href="about">Om projektet</a></li>
          </ul>
        </div>
    </nav>
    <div class="container">

      <div class="starter-template">
      	<div id="button-container" class="text-center">
	  		<span>Navigér:</span>
	  		<button type="button" class="btn btn-default btn-xs nav-buttons" id="get_last_image"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span> </button>
	  		<button type="button" class="btn btn-default btn-xs nav-buttons" id="get_next_image"><span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span> </button>
	  		<button type="button" class="btn btn-default btn-xs nav-buttons" id="get_new_image"><span class="glyphicon glyphicon-random" aria-hidden="true"></span> Tilfældigt</button>
	  		<span>Gem:</span>
	  		<button type="button" class="btn btn-default btn-xs nav-buttons" id="saveData"><span class="glyphicon glyphicon-floppy-saved" aria-hidden="true"></span> Gem tags</button>
	  		<!--<button type="button" class="btn btn-default btn-xs" onclick="location.href='/about';"><span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span> Hjælp</button>-->
	  		
      	</div>
        <p class="text-center" id="status"></p>
        <div>
	        <div id="image_container" class="fix">
	        	<img class="img-full-width" src="" class="taggd" id="tagging_image">
	        </div>
 		</div>
      	<div id="text-container" class="login">
        <p class="text-center">
        	<span id="stats" class="text-pad"></span>
        	<span>
        		<span id="userStats" class="text-pad">Log på for at tælle dine tags:&nbsp;</span>
    		</span>
    		<span class="fb-login-button text-pad" data-max-rows="1" data-size="medium" data-show-faces="false" data-auto-logout-link="true"></span>
		</p>
        </div>
      </div>
    </div>
    <div class="creative-commons-logo">
  		<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img class="pull-right" alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"></a>
	</div>
    </body>

    <script>

	var taggd = '';
	var taggd_user = '';

	$('#saveData').click(function(e){
		//$('#get_new_image').prop('disabled', true);
		//$('#saveData').prop('disabled', true);
		tagCtrl.saveData(taggd_user.data);/*.success(function(){
			$('#get_new_image').prop('disabled', false);
			$('#saveData').prop('disabled', false);
			
		});*/
		ga('send', 'event', 'image_tagging', 'save');
		$('#saveData').blur();
	});
	
	$("#get_new_image").click(function(e){
		updateImage();
		$('#get_new_image').blur();
		ga('send', 'event', 'image_navigation', 'random');
	});
	
	$("#get_next_image").click(function(e){
	    var nextId = parseInt(Helper.gup('image_id')) + 1;
		updateImage(nextId);
		$('#get_next_image').blur();
		ga('send', 'event', 'image_navigation', 'next');
	});
	
	$("#get_last_image").click(function(e){
	    var nextId = parseInt(Helper.gup('image_id')) - 1;
		updateImage(nextId);
		$('#get_last_image').blur();
		ga('send', 'event', 'image_navigation', 'last');
	});
	
	/**
	 * Updating an image
	 * This method loads a new image and adds it to the DOM
	 * when the loading is done
	 * When the actual image is received, the Taggd functionality is added.
	 * After that various buttons for sharing and navigating are added
	 * to the DOM
	 */ 
	var updateImage = function(image_id){
		$('.nav-buttons').each(function(){ $(this).prop('disabled',true); });

		Helper.updateStatus("henter billede...");
	
		if(taggd !== ''){
			taggd.dispose();
		}
		if(taggd_user !== ''){
			taggd_user.dispose();
		}
	
		$("#tagging_image").remove();
		$('#image_container').hide();
		$("#image_container").html(
		'<div id="taggd_container">' + 
			'<img class="img-full-width taggd" src="" class="taggd" id="tagging_image" />' +
        '<div>');
        
		receiver.getImage(image_id).success(function(newData){
			var img = new Image();
			
			img.onload = function () {
			//   $("#button").click(function() {
				  /*  $('html, body').animate({
				        scrollTop: $("#get_last_image").offset().top
				    }, 150);*/
			//	});
			   
			   $('.nav-buttons').each(function(){ $(this).prop('disabled',false); });
			   $('#image_container').show();
			   Helper.updateStatus('klik på billedet for at opmærke det. Tryk "Gem tags" når du er færdig. Find mere hjælp <a href="about">her</a> og i vores <a href="https://www.facebook.com/groups/drsbilleder">gruppe på Facebook</a>');
			    $('#tagging_image').attr('src', newData.image.resizedUrl);
				
				$('#fullsize_url').attr('href', newData.image.originalUrl);

				//Taggd options
				var options = {
					  align: {
					    y: 'bottom'
					  },
					
					  offset: {
					    top: -35
					  },
					
					handlers: {
				      mouseenter: 'show',
				      mouseleave: 'hide',
				    },
	
			    	edit: false,
			    	
			    	bloodhoundTypeahead: new Bloodhound({
					    datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
					    queryTokenizer: Bloodhound.tokenizers.whitespace,
					    //prefetch: '../data/films/post_1960.json',
					    remote: {
					      url: Helper.getUrl() + '/api/tags?term=%QUERY',
					      wildcard: '%QUERY'
					    }
				  	})
				};

				taggd = $('.taggd').taggd( options, [] );
				taggd.clear();
				if(newData.tags && newData.tags.length > 0){
					taggd.addData(newData.tags);
				}
				options.edit = true;
				taggd_user = $('.taggd').taggd( options, [] );
				
				//Add additional info from the image to the DOM
				var additionalInfoText = 
					(typeof newData.additional_info.uds_titel_begivenhed != 'undefined' && newData.additional_info.uds_titel_begivenhed.length > 0 ? 'Titel: ' + newData.additional_info.uds_titel_begivenhed + ' ' : '') + 
					(typeof newData.additional_info.aarstal != 'undefined' && newData.additional_info.aarstal.length > 0 ? 'Årstal: ' + newData.additional_info.aarstal + '. ' : '') + 
					(typeof newData.additional_info.fotograf != 'undefined' ? 'Fotograf: ' + newData.additional_info.fotograf : '');

			    $('#taggd_container').append('<div class="desc">' +
			    '<span style="color: black;padding-right: 6px;padding-left: 6px;padding-bottom: 4px;padding-top: 2px;">' + additionalInfoText + '</span>' +
           		'<button type="button" class="btn btn-default btn-xs" id="download-btn"><span class="glyphicon glyphicon-download-alt" aria-hidden="true"></span> Hent</button>' +
           		'<button type="button" class="btn btn-default btn-xs" id="share-btn"><span class="glyphicon glyphicon-share" aria-hidden="true"></span> Del på Facebook</button>' +
        		'</div>');
        	//	$('#facebook-share-link').attr('data-href', window.location.href.replace('html/','html/static.php'));
				$('#download-btn').click(function(){window.open(newData.image.url);});
				$('#share-btn').off();
				$('#share-btn').click(function(){
					var position = window.location.href.indexOf('?image_id');
					var a = window.location.href;
					var b = 'static.php';
					var href = [a.slice(0, position), b, a.slice(position)].join('');
					//console.log(href);
					//console.log(window.location.href.indexOf('?image_id'));
					//console.log(window.location.href.replace('html/','html/static.php'));
					FB.ui(
					 {
					  method: 'share',
					  href: href
					}, function(response){});
				});
				if(newData.image.id)
					window.history.pushState("", null, "?image_id=" + newData.image.id);
			};
			
			img.src = newData.image.resizedUrl;
		});
		
		getStats();
	};
	
	/**
	 * Get stats (number of images with tags and the users tags)
	 */ 
	var getStats = function()
	{
		receiver.getStats().success(function(data){
			$('#stats').html('Billeder med tags: <b>' + data.imagesWithTags + '</b>');
			if(data.userTags > 0){
				$('#userStats').html('Dine opmærkninger: <b>' + data.userTags + '</b>');
			}
		});
	}
	
	/**
	 * When the page is loaded an image is loaded based on the image id in the
	 * URL query (if any)
	 */ 
	$(function(){
	//	console.log(gup('image_id'));
		updateImage(Helper.gup('image_id'));
	});
	
</script>
</html>